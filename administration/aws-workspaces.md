# Managing AWS WorkSpaces

> When generating passwords, use something like the
> [random.org password generator](https://www.random.org/passwords).

## Seven-Step Deployment and Management Process

AWS WorkSpaces house the production deployment of teams' problem statement
solutions. As the backbone of the submissions process, it is imperative these
WorkSpaces are always and immediately available to students and judges when
necessary. This is facilitated via a seven step process:

<small> -- must be completed at least two weeks before the due date of PS1 --
</small> \
[Step 1: Setup "AWSWS" Worksheet in the HSCC Tracking Document](#step-1-setup-awsws-worksheet-in-the-hscc-tracking-document)
\
[Step 2: Setup WorkSpaces on AWS](#step-2-setup-workspaces-on-aws) \
[Step 3: Finalize Budget and Distribute Phase 1 Credentials](#step-3-finalize-budget-and-distribute-phase-1-credentials)

<small> -- must be completed when the PS1 submission window closes and phase 1
ends -- </small> \
[Step 4: End Phase 1](#step-4-end-phase-1)

<small> -- must be completed at least 30 minutes before phase 2 (and the HSCC
competition) begins -- </small> \
[Step 5: Prepare for Phase 2](#step-5-prepare-for-phase-2)

<small> -- must be completed after phase 2 ends (i.e. after the extra 1 hour
submission allowance) -- </small> \
[Step 6: End Phase 2](#step-6-end-phase-2)

<small> -- must be completed after team presentation phase ends -- </small> \
[Step 7: Set WorkSpaces Final Password](#step-7-set-workspaces-final-password)

<small> -- must be completed after the conference ends (usually around a month
after) -- </small> \
[Step 8: Cleanup WorkSpaces](#step-8-cleanup-workspaces)

<small> -- must be completed by the chief judge after step #8 -- </small> \
[Step 9: Prune Private Keys](#step-9-prune-private-keys)

### Step 1: Setup "AWSWS" Worksheet in the HSCC Tracking Document

1. Gain access to this year's "HSCC 2XXX Tracking" document on Google Drive.

2. Navigate to the "AWSWS" tab, or create it if it does not already exist. Look
   at previous years' tracking documents for examples of the expected structure,
   which is described below:

   - Ensure one row exists for each chapter participating this year, and that
     there are no chapters listed that are not participating. Each row must
     have: chapter name, chapter abbreviation, AWSWS username (**"abc-XXXX" for
     chapter "Abc" where "XXXX" are two random letters and two random
     numbers**), AWSWS password (randomly generated 30-character password), and
     AWSWS registration code. The registration code is generated by AWS and will
     be the same across all workspaces.

   - Ensure one row exists for the NHSCC workspace, which should have "NHSCC" as
     the chapter name, no abbreviation, "nhscc" as the AWSWS username, a
     randomly generated password, and the shared registration code.

   - Ensure one row exists for the **judge-specific password**. This must be a
     secure 30-character password and it must not be reused year-to-year. This
     password is used by judges to access the workspaces after submissions have
     closed for a phase.

   - Ensure one row exists for the **final password**. This should be a random
     30-character password and it must not be reused year-to-year. This password
     is what the WorkSpaces are set to use after the PS2 presentations conclude.
     It is important that this password is never given out or known outside of
     the national HSCC immediate staff.

### Step 2: Setup WorkSpaces on AWS

1. Gain access to the BDPA
   [AWS management console](https://aws.amazon.com/console/).

2. Navigate to `Services > WorkSpaces` from the Services menu.

3. [Create an Active Directory and each of the WorkSpaces](https://docs.aws.amazon.com/workspaces/latest/adminguide/launch-workspace-simple-ad.html).
   Be sure to record the administrator password for the directory in case it is
   needed later.

   - Use a Simple Active Directory ("simple AD").

     - DNS name should be `submissions.hscc.bdpa.org`.

     - DNS short name should be `hscc`.

     - **[Enable Linux client access](https://docs.aws.amazon.com/workspaces/latest/userguide/amazon-workspaces-linux-client.html#linux-requirements)**.

   - Select the WorkSpace value bundle (or whichever bundle costs least this
     year).

     - Select Windows OS, smallest drive sizes, without Microsoft Office or any
       other software.

   - Select the "always on" WorkSpaces, not the "auto stop" WorkSpaces.

4. Login to each WorkSpace via
   [the desktop client](https://clients.amazonworkspaces.com) to ensure that the
   [recorded credentials](#step-1-setup-awsws-worksheet-in-the-hscc-tracking-document)
   work.

   Additionally, for each WorkSpace, you must add the chapter's abbreviation
   (three letters) to the task bar. This will make it easy for judges to figure
   out which chapter's WorkSpace they are looking at. To add a chapter
   abbreviation to the task bar:

   1. Right click on the empty portion of the Windows task bar on the right-side
      of the task bar, directly to the left of the up arrow that shows hidden
      icons.

   2. Select `Toolbars > New toolbar...`.

   3. Within the `Documents` folder, create a new folder called `XXX` where
      `XXX` represents the chapter's three-character abbreviation. These
      abbreviations can be found in the
      ["HSCC 2XXX Tracking" document on Google Drive](#step-1-setup-awsws-worksheet-in-the-hscc-tracking-document).

   4. Select this folder and click the "Select Folder" button.

   5. You should now see the three-character abbreviation on the right-side of
      the task bar.

   Finally, Windows Defender and UAC must be disabled in each WorkSpace.

   1. Start PowerShell in administrator mode.

   2. Execute the following command:
      `Uninstall-WindowsFeature -Name Windows-Defender`

   3. Disable UAC (User Account Control)

      > start menu ⮕ type "UAC" into search bar ⮕ select "Change User Account
      > Control settings" ⮕ set to "never notify" and click "OK"

   4. Restart the WorkSpace.

### Step 3: Finalize Budget and Distribute Phase 1 Credentials

1. Decide on the "stop time," the moment when the WorkSpaces will be
   [deleted](https://docs.aws.amazon.com/workspaces/latest/adminguide/delete-workspaces.html)
   from AWS. For instance, if the conference is in mid-August, then some point
   in mid-September will suffice.

2. Report
   [projected monthly and total costs](https://aws.amazon.com/aws-cost-management/aws-cost-explorer/)
   (with respect to the "stop time") and "stop time" to NHSCC as early as
   possible.

3. Distribute WorkSpaces credentials and setup instructions to teams via Slack
   direct message to each chapter's coordinator. Use the following message
   template (replace the four `X`'s with their proper values):

> Good morning `X`,
>
> Same as last year, teams will be required to submit their solutions via Amazon
> WorkSpaces and the Reviewr submission portal. Have your team follow the steps
> below to get your Workspace up and running:
>
> 1. Download and install a WorkSpaces Client for your favorite devices:
>    https://clients.amazonworkspaces.com
> 2. Launch the client and enter the following registration code: `X`
> 3. Login with your password: `X`. Your username is `X`
>
> Keep in mind: students must know their WorkSpace and Reviewr submission portal
> credentials to complete PS2, even if it is the coordinators who are submitting
> PS1 on behalf of their team. If you need any assistance accessing your team's
> WorkSpace or you have any other questions or concerns about submitting, please
> let me know

4. Make an announcement on Slack via the `#_hscc` and `#announcements` channels
   that credentials have gone out and anyone who has not received theirs should
   contact you ASAP.

### Step 4: End Phase 1

At **[11:59PM Pacific Time](https://time.is/PT)** on the day the PS1 submission
window closes:

1. All WorkSpaces passwords (except the NHSCC WorkSpace) must be
   [reset](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_manage_users_groups_reset_password.html)
   to the same judge-specific password. This can be done quickly from the
   "Directories" tab in the side bar.

2. WorkSpaces (except the NHSCC WorkSpace) must be
   [rebooted](https://docs.aws.amazon.com/workspaces/latest/adminguide/reboot-workspaces.html).

> **At this point, this chief judge should look for foreign private keys or
> other evidence of illegal remote access and penalize/disqualify teams as
> appropriate.**

### Step 5: Prepare for Phase 2

Some time after judging for PS1 concludes, and **at least 30 minutes before
phase 2 begins**:

1. Each WorkSpace password (except the NHSCC WorkSpace) must be
   [reset](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_manage_users_groups_reset_password.html)
   back to its original value. These values can be found in the
   ["HSCC 2XXX Tracking" document on Google Drive](#step-1-setup-awsws-worksheet-in-the-hscc-tracking-document).
   Password resets can be done quickly from the "Directories" tab in the side
   bar.

2. WorkSpaces (except the NHSCC WorkSpace) must be
   [rebooted](https://docs.aws.amazon.com/workspaces/latest/adminguide/reboot-workspaces.html).

### Step 6: End Phase 2

After the phase 2 submission grace period (usually exactly one hour after the
programming portion of phase 2 ends) concludes, teams must be locked out all
WorkSpaces instances. Specifically:

1. All WorkSpaces passwords (except the NHSCC WorkSpace) must be
   [reset](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_manage_users_groups_reset_password.html)
   to the same judge-specific password. This can be done quickly from the
   "Directories" tab in the side bar.

2. WorkSpaces (except the NHSCC WorkSpace) must be
   [rebooted](https://docs.aws.amazon.com/workspaces/latest/adminguide/reboot-workspaces.html).

### Step 7: Set WorkSpaces Final Password

Once the presentation phase of the competition ends, and teams/judges are no
longer allowed to interact with the WorkSpaces, everyone except NHSCC staff must
be locked out of all WorkSpaces instances. Specifically:

1. All WorkSpaces passwords (except the NHSCC WorkSpace) must be
   [reset](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_manage_users_groups_reset_password.html)
   to the same **final** password. This can be done quickly from the
   "Directories" tab in the side bar.

> Additionally, each WorkSpace must be
> [configured to serve requests from the https://xxx.submissions.hscc.bdpa.org domain](#making-team-solutions-accessible-over-the-internet).
> This part is usually handled by the chief judge.

> **At this point, you should look for foreign private keys or other evidence of
> illegal remote access and penalize/disqualify teams as appropriate.**

### Step 8: Cleanup WorkSpaces

Around a month after the conference ends and inline with the "stop time"
determined in
[Step 3](#step-3-finalize-budget-and-distribute-phase-1-credentials), all
WorkSpaces should be stopped and
[permanently deleted](https://docs.aws.amazon.com/workspaces/latest/adminguide/delete-workspaces.html).

### Step 9: Prune Private Keys

Delete any BDPA-specific private keys from the Nginx server responsible for
serving requests.

## Making Team Solutions Accessible Over The Internet

> You can see why we require teams to make their solutions accessible at
> `http://127.0.0.1:3000` [here](#example-nginx-configuration): doing so allows
> us to easily apply the
> [`sub_filter`](https://nginx.org/en/docs/http/ngx_http_sub_module.html) for
> high-fidelity reverse-proxying.

Usually the following process is completed by the chief judge. Though it is
designed with specific systems in mind, the process can be applied to any
web-visible system capable of serving requests via
[Nginx](https://www.nginx.com/).

1. Ensure DNS is configured (one three-letter subdomain per WorkSpace)

2. Ensure Nginx is configured (reverse proxy for servers hosted on WorkSpaces)

3. Ensure fault-tolerant SOCKS5 tunnels are established (one per WorkSpace)

4. Ensure end-to-end fidelity

### SOCKS5 Setup

Requires existing `bdpa-submit` locked down user account on the server running
Nginx (i.e. `XUNNPRIME`):

```
sudo adduser --system --no-group bdpa-submit
sudo -u bdpa-submit mkdir /home/bdpa-submit/.ssh
sudo -u bdpa-submit touch /home/bdpa-submit/.ssh/authorized_keys
sn /home/bdpa-submit/.ssh/authorized_keys
```

1. Setup DNS CNAME records for `XXX.submissions.hscc.bdpa.org`. The record
   should redirect to `prime.dns.xunn.io`

2. On each WorkSpace:

   1. Login to Discord in a private browsing instance.

   2. [Download](https://github.com/PowerShell/Win32-OpenSSH/releases) and
      unpack OpenSSH to desktop folder.

   3. Open command prompt inside OpenSSH folder.

   4. Create an SSH keypair and save it to this folder:
      `ssh-keygen -t ed25519 -C XXX`

   5. Add public key to `XUNNPRIME` `bdpa-submit` user's authorized keys.

   6. Use ssh client to open tunnel between `XUNNPRIME` and the WorkSpace.
      Example command (using port 8080):

      ```
      ssh -o ConnectTimeout=5 -o IdentityFile=D:\Users\20XX-XXXXXX\Desktop\OpenSSH-Win64\OpenSSH-Win64\id_ed25519 -CNR 80XX:127.0.0.1:3000 bdpa-submit@prime.dns.xunn.io
      ```

   7. Adjust apache/nginx/etc on the WorkSpace so that navigating to
      `XXX.submissions.hscc.bdpa.org` lands on the solution's home page.

### Well-Known Ports

The current HTTP proxy ports are:

| TEAM | PORT |
| :--: | :--: |
| WDC  | 8080 |
| MKE  | 8081 |
| TWN  | 8082 |
| ATL  | 8083 |
| SMN  | 8084 |
| STL  | 8085 |
| NYC  | 8086 |
| NOV  | 8087 |

The current WebSocket (WSS) proxy ports are:

| TEAM | PORT  |
| :--: | :---: |
| WDC  | 18080 |
| MKE  | 18081 |
| TWN  | 18082 |
| ATL  | 18083 |
| SMN  | 18084 |
| STL  | 18085 |
| NYC  | 18086 |
| NOV  | 18087 |

### Example Nginx Configuration

You can see the various Nginx configurations used over the years in the
[here](./nginx). It is likely that various teams' entries will have to be
tweaked year over year.
